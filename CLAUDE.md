# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Superpets is a full-stack monorepo application for AI-powered pet image editing using Google's Nano Banana model via fal.ai. The project transforms pet photos into superhero versions.

**Monorepo Structure:**
- **Backend** (`superpets-backend/`): Ktor (Kotlin) REST API server
- **Frontend** (`superpets-web/`): React + TypeScript + Vite web application
- **Mobile** (`superpets-mobile/`): Empty placeholder for future development

## Current Deployment Status

**Backend:** Deployed to Render ✅
- Production URL: https://superpets-backend-pipp.onrender.com
- Database: Supabase PostgreSQL (migrated from Firebase Firestore)
- Authentication: Supabase Auth (migrated from Firebase Auth)
- Deployment: Automatic from `main` branch on GitHub
- Status: Live and operational

**Frontend:** Deployed to Firebase Hosting ✅
- Production URL: https://superpets.fun (custom domain)
- Firebase Hosting URL: https://superpets-ee0ab.web.app
- Connected to Render backend via environment variables
- Deployment: Automatic via GitHub Actions (on push to `main`)
- CI/CD: `.github/workflows/firebase-deploy.yml`
- Status: Live and operational

**Domain:**
- Custom domain: **superpets.fun**
- Configured through Firebase Hosting

## Architecture

### Backend (Ktor - Kotlin)

**Directory:** `superpets-backend/`

**Key Services:**
- `NanoBananaService`: fal.ai API integration for image editing and file uploads
- `SupabaseService`: User data, credit system, transactions, edit history (PostgreSQL)
- `SupabaseAuthService`: Supabase JWT token verification
- `HeroService`: Hero data management and prompt generation
- `StripeService`: Payment processing (Stripe integration)
- `DatabaseFactory`: PostgreSQL connection management with HikariCP

**Database Layer:**
- **ORM:** Exposed (Kotlin SQL framework)
- **Connection Pool:** HikariCP
- **Database:** Supabase PostgreSQL
- **Tables:** `users`, `credit_transactions`, `edit_history`
- **Migration:** See `SUPABASE_MIGRATION.md` and `supabase_migration.sql`

**Authentication Flow:**
- Supabase JWT bearer token authentication (`supabase-auth`)
- Token verification via `SupabaseAuthService.verifyToken()`
- User ID extracted to `UserIdPrincipal` for route handlers
- Tokens generated by Supabase Auth on frontend

**Credit System:**
- New users auto-created with **5 free credits** on first API access
- Pricing: **1 credit per image generated** (not per request)
  - Example: 5 images = 5 credits, 1 image = 1 credit
- Atomic credit transactions using PostgreSQL transactions
- Full transaction history tracked in `credit_transactions` table
- Client-side and server-side credit validation before processing

**Main API Routes:**
- `/heroes` - Get all available heroes (public, no auth)
- `/nano-banana/edit` - Edit images from URLs (requires `hero_id`, 1-10 outputs)
- `/nano-banana/upload-and-edit` - Upload and edit (multipart/form-data, requires `hero_id`, 1-10 files)
- `/user/profile` - Get user profile (auto-creates with 5 credits)
- `/user/credits` - Get credit balance
- `/user/transactions` - Get transaction history
- `/user/edits` - Get edit history
- `/user/credits/add` - Add credits (admin/webhook)
- `/stripe/webhook` - Stripe payment webhook
- `/stripe/create-checkout-session` - Create Stripe checkout

All authenticated routes require `Authorization: Bearer <supabase-jwt-token>` header.

**Hero-Based Prompt System:**
- Heroes defined in `heroes.json` (10 classics + 19 unique heroes)
- Categories: "classics" (Superman, Batman, etc.) and "uniques" (custom characters)
- Edit endpoints **require** `hero_id` (custom prompts removed)
- **Multi-image variety**: When `num_images > 1`, each gets a unique random scene
  - Prompts generated upfront before parallel API calls
  - Example: 4 images = 4 different scenes from hero's 10 options
- Prompt format: "Transform the pet into {hero}. Keep the pet's identity like face, fur, and body proportions etc exactly the same. Add {identity}. Place them {scene}. Avoid distortions or altering the pet's natural features."
- Prompt building happens server-side before calling fal.ai

**Parallel Processing:**
- Multiple output images processed in parallel for performance
- Each parallel request gets unique prompt (different scene)
- All requests share the same input images
- Performance: 10 images in ~15 seconds (vs 150 seconds sequential)

**Deployment Configuration:**
- `Dockerfile`: Multi-stage build (Gradle + OpenJDK 17)
- Environment variables needed:
  - `SUPABASE_DB_URL`: PostgreSQL connection string (transaction pooler for IPv4 compatibility)
  - `SUPABASE_URL`: Supabase project URL
  - `SUPABASE_JWT_SECRET`: JWT secret for token verification
  - `FAL_API_KEY`: fal.ai API key
  - `STRIPE_SECRET_KEY`: Stripe secret key
  - `STRIPE_WEBHOOK_SECRET`: Stripe webhook secret

**Important Supabase Notes:**
- Use **Transaction Pooler** connection string (port 6543) for cloud deployments (Render, Cloud Run, etc.)
- Direct connection (port 5432) is **not IPv4 compatible** - will fail on most cloud platforms
- Transaction pooler format: `postgresql://postgres.<project-ref>:<password>@aws-0-us-east-1.pooler.supabase.com:6543/postgres`
- See `SUPABASE_MIGRATION.md` for complete migration details

### Frontend (React + TypeScript)

**Directory:** `superpets-web/`

**Project Structure:**
- `src/lib/` - API client (`api.ts`), Supabase config (`supabase.ts`), TypeScript types
- `src/contexts/` - React contexts (CreditsContext for global credit state)
- `src/hooks/` - Custom hooks (`useAuth`, `useImageEdit`)
- `src/components/` - Feature-organized components (Auth, Dashboard, Editor)
- `src/pages/` - Page components (EditorPage, PricingPage)

**Key Patterns:**
- Supabase authentication via `useAuth` hook
- Global credit state via `CreditsProvider` context
- Centralized API calls in `api.ts` with automatic token injection
- Error handling for `UNAUTHORIZED` and `INSUFFICIENT_CREDITS` states
- **Client-side credit validation** before API calls
  - Button disabled when `credits < numImages`
  - Validation error shown immediately without API call
- **Hero selection required** - custom prompts removed from UI
- Dynamic credit cost display: "Generate Images (5 credits)"

**API Configuration:**
- Development: `http://localhost:8080`
- Production: `https://superpets-backend-pipp.onrender.com` (configured in `.env.production`)
- Base URL managed via `VITE_API_BASE_URL` environment variable
- Authentication: Bearer tokens from Supabase Auth
- Image generation limit: 1-10 images per request

**Tech Stack:**
- React 19 with TypeScript
- Vite for build tooling
- Tailwind CSS for styling
- Supabase JS SDK for authentication
- Lucide React for icons
- date-fns for date formatting

## Development Commands

### Backend (Ktor)

Navigate to `superpets-backend/`:

```bash
# Run dev server (localhost:8080)
./gradlew run

# Run with Supabase environment variables
export SUPABASE_DB_URL="postgresql://postgres.<ref>:<pass>@aws-0-us-east-1.pooler.supabase.com:6543/postgres"
export SUPABASE_URL="https://<project-ref>.supabase.co"
export SUPABASE_JWT_SECRET="<your-jwt-secret>"
export FAL_API_KEY="<your-key>"
export STRIPE_SECRET_KEY="<your-key>"
export STRIPE_WEBHOOK_SECRET="<your-secret>"
./gradlew run

# Run tests
./gradlew test

# Build JAR with dependencies
./gradlew shadowJar

# Build Docker image locally
docker build -t superpets-backend .

# Run Docker container locally
docker run -p 8080:8080 \
  -e SUPABASE_DB_URL="postgresql://..." \
  -e SUPABASE_URL="https://..." \
  -e SUPABASE_JWT_SECRET="..." \
  -e FAL_API_KEY="your_key" \
  -e STRIPE_SECRET_KEY="your_key" \
  -e STRIPE_WEBHOOK_SECRET="your_secret" \
  superpets-backend
```

**Environment Configuration:**
- Requires `.env` file in project root with Supabase credentials (DO NOT COMMIT)
- `heroes.json` must be in project root (contains hero definitions)
- See `SUPABASE_MIGRATION.md` for database setup

**Test Interface:**
- HTML test interface at `http://localhost:8080/index.html`
- Includes Supabase auth, API testing, image upload with hero selection
- Hero selection UI with "Classic Heroes" and "Unique Heroes" tabs

### Frontend (React)

Navigate to `superpets-web/`:

```bash
# Install dependencies
npm install

# Run dev server (with hot reload)
npm run dev

# Build for production
npm run build

# Preview production build
npm run preview

# Deploy to Firebase Hosting (manual)
firebase deploy

# Lint code
npm run lint
```

**Environment Variables:**
- `.env` - Development configuration (localhost backend)
- `.env.production` - Production configuration (Render backend)
- Vite automatically loads correct env file based on mode

**CI/CD:**
- Automatic deployment via GitHub Actions on push to `main`
- Workflow file: `.github/workflows/firebase-deploy.yml`
- Setup instructions: See `GITHUB_ACTIONS_SETUP.md`
- Requires GitHub secrets: `FIREBASE_SERVICE_ACCOUNT`, `VITE_STRIPE_PUBLISHABLE_KEY`

## Important Implementation Details

### Supabase Configuration
- Backend: Database connection via HikariCP with connection pooling
- Backend: JWT token verification for authentication
- Frontend: Supabase JS client SDK in `src/lib/supabase.ts`
- **Security:** CORS set to `anyHost()` - **MUST restrict for production**

### Credit System Flow
1. User authenticates via Supabase Auth
2. First API call auto-creates user with 5 credits in PostgreSQL
3. Before image edit, credits are deducted atomically via SQL transaction
4. Edit is performed only if deduction succeeds
5. Edit history saved to PostgreSQL for user reference

### File Upload Flow
1. Client sends multipart form data to `/nano-banana/upload-and-edit`
2. Backend extracts files and metadata (including `hero_id`)
3. If `hero_id` provided, prompt generated using `HeroService.buildPrompt()`
4. Files uploaded to fal.ai storage via `NanoBananaService.uploadFile()`
5. Returned URLs and final prompt used in `editImage()` request
6. Result and history saved to Supabase PostgreSQL

### Stripe Payment Integration
- See `STRIPE_SETUP.md` for detailed implementation guide
- Checkout session creation via `/stripe/create-checkout-session`
- Webhook handling at `/stripe/webhook` for payment confirmation
- Credit packages configurable via Stripe product metadata

### Hero System Files
**Backend:**
- `heroes.json` - Hero data file (10 classics + 19 uniques)
- `src/main/kotlin/models/HeroModels.kt` - Data models
- `src/main/kotlin/services/HeroService.kt` - Hero loading and prompt building

**Frontend (Test HTML):**
- `src/main/resources/static/index.html` - Hero selection UI
  - Fetches heroes from `/heroes` endpoint
  - Displays in tabbed grid (classics/uniques)
  - Sends `hero_id` in form data

### Database Schema
See `supabase_migration.sql` for complete schema. Key tables:

**users:**
- `uid` (primary key) - Supabase user ID
- `email` - User email
- `credits` - Current credit balance
- `created_at` - Account creation timestamp

**credit_transactions:**
- `id` (UUID, primary key)
- `user_id` (foreign key to users)
- `amount` - Credit amount (positive for additions, negative for deductions)
- `type` - Transaction type (PURCHASE, SIGNUP_BONUS, DEDUCTION, etc.)
- `description` - Transaction description
- `timestamp` - Transaction timestamp

**edit_history:**
- `id` (UUID, primary key)
- `user_id` (foreign key to users)
- `prompt` - Generated prompt used
- `input_images` - JSON array of input image URLs
- `output_images` - JSON array of output image URLs
- `credits_cost` - Credits deducted for this edit
- `timestamp` - Edit timestamp

### Error Handling
- `401 Unauthorized` - Invalid/expired Supabase JWT token
- `402 Payment Required` - Insufficient credits
- Credits checked before API calls, refunds not implemented
- All database operations wrapped in try/catch with logging

## Git Repository

- **GitHub:** `https://github.com/alicankorkmaz-sudo/superpets`
- **Branch:** `main`
- **Structure:** Monorepo with separate subdirectories for backend, web, and mobile

## Next Steps / TODO

See `PROJECT_STATE.md` for current progress and next steps.

**Completed (Oct 5, 2025):**
- ✅ Deployed backend to Render with Supabase pooler connection
- ✅ Migrated frontend to Supabase Auth
- ✅ Deployed frontend to Firebase Hosting
- ✅ Configured custom domain: superpets.fun

**Remaining priorities:**
1. **Implement CORS restrictions** (currently set to `anyHost()` - security risk)
2. **Complete Stripe payment integration** (checkout sessions configured, needs webhook testing)
3. **Add rate limiting and input validation**
4. **Configure custom domain SSL/HTTPS** (if not auto-configured by Firebase)
5. **Monitor and optimize Render backend performance** (free tier may spin down)
6. **Set up error monitoring and analytics** (Sentry, LogRocket, etc.)

See `LAUNCH_CHECKLIST.md` for comprehensive pre-launch checklist.

## Notes

- **memorize** - This instruction ensures AI assistants remember key project details
- All secrets managed via environment variables (never committed to git)
- Supabase credentials stored as environment variables for deployment
- Hero prompt system is server-side only (clients cannot send custom prompts)
- **Migrated from Firebase to Supabase** (October 5, 2025)
- Deployed to Render (backend)
- memorize
