# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## üìö Session Initialization

**IMPORTANT:** When starting a new session, Claude Code should:

1. **Read this file first** (CLAUDE.md) - Main project instructions
2. **Check `.claude/session-init.md`** - Complete documentation index with 35+ AI-generated files
3. **Review `PROJECT_STATE.md`** - Current progress and priorities

**Documentation Discovery System:**
This project has an extensive collection of AI-generated documentation files organized across the monorepo. The `.claude/session-init.md` file maintains a comprehensive index of all documentation, organized by category (Setup, Auth, Database, Mobile, etc.). Refer to that file to discover relevant documentation for your current task without needing to be explicitly pointed to specific files.

**Updating Documentation Index:**
When creating new documentation files during feature implementation, the user may tell you to:
- **"Update docs"** - Run the discovery script and update `.claude/session-init.md` with any new files
- **"Update session-init"** - Same as above
- **"Refresh documentation index"** - Same as above

When you receive any of these commands, you should:
1. Run `./.claude/update-docs-index.sh` to discover new files
2. Update `.claude/session-init.md` with any new documentation files found
3. Organize new files into the appropriate category
4. Update the total documentation count
5. Mark critical files with ‚≠ê if they're important for most sessions

## Project Overview

Superpets is a full-stack monorepo application for AI-powered pet image editing using Google's Nano Banana model via fal.ai. The project transforms pet photos into superhero versions.

**Monorepo Structure:**
- **Backend** (`superpets-backend/`): Ktor (Kotlin) REST API server
- **Frontend** (`superpets-web/`): React + TypeScript + Vite web application
- **Mobile** (`superpets-mobile/`): Compose Multiplatform (Android & iOS) with OAuth support

## Current Deployment Status

**Backend:** Deployed to Railway ‚úÖ
- Production URL: https://api.superpets.fun (custom subdomain)
- Railway Project: https://railway.com/project/b7df09da-2741-413c-8474-4baab3059775
- Database: Supabase PostgreSQL (migrated from Firebase Firestore)
- Authentication: Supabase Auth (migrated from Firebase Auth)
- Deployment: Manual via Railway CLI (`railway up`) or automatic from GitHub
- Status: Live and operational

**Frontend:** Deployed to Firebase Hosting ‚úÖ
- Production URL: https://superpets.fun (custom domain)
- Firebase Hosting URL: https://superpets-ee0ab.web.app
- Connected to Railway backend via environment variables
- Deployment: Automatic via GitHub Actions (on push to `main`)
- CI/CD: `.github/workflows/firebase-deploy.yml`
- Status: Live and operational

**Domain:**
- Custom domain: **superpets.fun**
- Configured through Firebase Hosting

## Architecture

### Backend (Ktor - Kotlin)

**Directory:** `superpets-backend/`

**Key Services:**
- `NanoBananaService`: fal.ai API integration for image editing and file uploads
- `SupabaseService`: User data, credit system, transactions, edit history (PostgreSQL)
- `SupabaseAuthService`: Supabase JWT token verification
- `HeroService`: Hero data management and prompt generation
- `StripeService`: Payment processing (Stripe integration)
- `DatabaseFactory`: PostgreSQL connection management with HikariCP

**Database Layer:**
- **ORM:** Exposed (Kotlin SQL framework)
- **Connection Pool:** HikariCP
- **Database:** Supabase PostgreSQL
- **Tables:** `users`, `credit_transactions`, `edit_history`
- **Migration:** See `SUPABASE_MIGRATION.md` and `supabase_migration.sql`

**Authentication Flow:**
- Supabase JWT bearer token authentication (`supabase-auth`)
- Token verification via `SupabaseAuthService.verifyToken()`
- User ID extracted to `UserIdPrincipal` for route handlers
- Tokens generated by Supabase Auth on frontend

**Credit System:**
- New users auto-created with **5 free credits** on first API access
- Pricing: **1 credit per image generated** (not per request)
  - Example: 5 images = 5 credits, 1 image = 1 credit
- Atomic credit transactions using PostgreSQL transactions
- Full transaction history tracked in `credit_transactions` table
- Client-side and server-side credit validation before processing

**Rate Limiting:**
- Sliding window algorithm with in-memory tracking (`RateLimitingService`)
- **Public endpoints** (IP-based): 60 requests/minute (/, /heroes)
- **User profile endpoints** (per-user): 30 requests/minute
- **Image generation endpoints** (per-user): 5 requests/minute
- **Admin operations** (per-user): 10 requests/minute
- **Stripe webhook** (IP-based): 100 requests/minute
- Returns HTTP 429 with `X-RateLimit-*` headers when exceeded

**File Upload Validation:**
- Maximum file size: **10MB** (enforced via `FileValidation` utility)
- Allowed types: `image/jpeg`, `image/png`, `image/webp`, `image/gif`
- Validates both MIME type and file extension
- Returns HTTP 400 with specific error message on validation failure
- Mobile apps should compress images to 2048x2048 before upload

**Main API Routes:**
- `/heroes` - Get all available heroes (public, no auth)
- `/nano-banana/edit` - Edit images from URLs (requires `hero_id`, 1-10 outputs)
- `/nano-banana/upload-and-edit` - Upload and edit (multipart/form-data, requires `hero_id`, 1-10 files)
- `/user/profile` - Get user profile (auto-creates with 5 credits)
- `/user/credits` - Get credit balance
- `/user/transactions` - Get transaction history
- `/user/edits` - Get edit history
- `/user/credits/add` - Add credits (admin/webhook)
- `/stripe/webhook` - Stripe payment webhook
- `/stripe/create-checkout-session` - Create Stripe checkout

All authenticated routes require `Authorization: Bearer <supabase-jwt-token>` header.

**Hero-Based Prompt System:**
- Heroes defined in `heroes.json` (10 classics + 19 unique heroes)
- Categories: "classics" (Superman, Batman, etc.) and "uniques" (custom characters)
- Edit endpoints **require** `hero_id` (custom prompts removed)
- **Multi-image variety**: When `num_images > 1`, each gets a unique random scene
  - Prompts generated upfront before parallel API calls
  - Example: 4 images = 4 different scenes from hero's 10 options
- Prompt format: "Transform the pet into {hero}. Keep the pet's identity like face, fur, and body proportions etc exactly the same. Add {identity}. Place them {scene}. Avoid distortions or altering the pet's natural features."
- Prompt building happens server-side before calling fal.ai

**Parallel Processing:**
- Multiple output images processed in parallel for performance
- Each parallel request gets unique prompt (different scene)
- All requests share the same input images
- Performance: 10 images in ~15 seconds (vs 150 seconds sequential)

**Deployment Configuration:**
- `Dockerfile`: Multi-stage build (Gradle + OpenJDK 17)
- Environment variables needed:
  - `SUPABASE_DB_URL`: PostgreSQL connection string (transaction pooler for IPv4 compatibility)
  - `SUPABASE_URL`: Supabase project URL
  - `SUPABASE_JWT_SECRET`: JWT secret for token verification
  - `FAL_API_KEY`: fal.ai API key
  - `STRIPE_SECRET_KEY`: Stripe secret key
  - `STRIPE_WEBHOOK_SECRET`: Stripe webhook secret

**Important Supabase Notes:**
- Use **Transaction Pooler** connection string (port 6543) for cloud deployments (Railway, Render, Cloud Run, etc.)
- Direct connection (port 5432) is **not IPv4 compatible** - will fail on most cloud platforms
- Transaction pooler format: `postgresql://postgres.<project-ref>:<password>@aws-0-us-east-1.pooler.supabase.com:6543/postgres`
- See `SUPABASE_MIGRATION.md` for complete migration details

### Frontend (React + TypeScript)

**Directory:** `superpets-web/`

**Project Structure:**
- `src/lib/` - API client (`api.ts`), Supabase config (`supabase.ts`), TypeScript types
- `src/contexts/` - React contexts (CreditsContext for global credit state)
- `src/hooks/` - Custom hooks (`useAuth`, `useImageEdit`)
- `src/components/` - Feature-organized components (Auth, Dashboard, Editor)
- `src/pages/` - Page components (LandingPage, EditorPage, PricingPage, TermsOfServicePage, PrivacyPolicyPage, AuthCallbackPage, AdminDashboardPage)

**Landing Page & Navigation:**
- **LandingPage component** - Welcoming first-time visitors before signup/login
  - Hero section with value proposition and CTAs
  - Features section (AI-powered, 29+ heroes, lightning-fast)
  - "How It Works" 3-step guide
  - Pricing teaser highlighting 5 free credits
- **URL-based navigation** - Proper browser history support
  - `/` - Landing page (non-authenticated users)
  - `/?auth=login` - Login form
  - `/?auth=signup` - Signup form
  - `/auth/callback` - OAuth callback handler (Google & Apple Sign-In)
  - `/terms` - Terms of Service
  - `/privacy` - Privacy Policy
  - `/pricing` - Pricing page
  - `/admin` - Admin dashboard
  - Browser back/forward buttons work correctly via History API
- **Back buttons** - "Back to home" on login/signup forms for easy navigation

**Authentication Features:**
- ‚úÖ Email/password authentication
- ‚úÖ Google OAuth Sign-In (with popup flow)
- ‚úÖ Apple OAuth Sign-In (with popup flow)
- ‚úÖ Email confirmation for new signups
- ‚úÖ OAuth callback handling via AuthCallbackPage
- ‚úÖ Session persistence and auto-login
- ‚úÖ Error handling for "Email not confirmed" state

**Key Patterns:**
- Supabase authentication via `useAuth` hook
- Global credit state via `CreditsProvider` context
- Centralized API calls in `api.ts` with automatic token injection
- Error handling for `UNAUTHORIZED` and `INSUFFICIENT_CREDITS` states
- **Client-side credit validation** before API calls
  - Button disabled when `credits < numImages`
  - Validation error shown immediately without API call
- **Hero selection required** - custom prompts removed from UI
- Dynamic credit cost display: "Generate Images (5 credits)"

**API Configuration:**
- Development: `http://localhost:8080`
- Production: `https://api.superpets.fun` (custom subdomain, configured in `.env.production`)
- Base URL managed via `VITE_API_BASE_URL` environment variable
- Authentication: Bearer tokens from Supabase Auth
- Image generation limit: 1-10 images per request

**Tech Stack:**
- React 19 with TypeScript
- Vite for build tooling
- Tailwind CSS for styling
- Supabase JS SDK for authentication
- Lucide React for icons
- date-fns for date formatting

**Web App Icons & PWA:**
- ‚úÖ **Favicon**: `favicon.ico` for browser tabs and bookmarks
- ‚úÖ **Apple Touch Icon**: `apple-touch-icon.png` (180x180) for iOS home screen
- ‚úÖ **PWA Icons**: 192x192 and 512x512 PNG icons (standard and maskable variants)
- ‚úÖ **Web App Manifest**: `manifest.json` for Progressive Web App support
  - Configured for standalone display mode
  - Theme color and background color set to white
  - Proper icon references for installation prompts
- Location: `superpets-web/public/`

### Mobile (Compose Multiplatform)

**Directory:** `superpets-mobile/`

**Platform Support:**
- **Android** - Native Android app
- **iOS** - Native iOS app

**Project Structure:**
- Template: [AstroturfStudio/cmp-template](https://github.com/AstroturfStudio/cmp-template)
- Package: `com.superpets.mobile`
- Architecture: MVVM with clean architecture
- `composeApp/src/commonMain/` - Shared business logic and UI
- `composeApp/src/androidMain/` - Android-specific code
- `composeApp/src/iosMain/` - iOS-specific code

**Tech Stack:**
- **UI:** Compose Multiplatform with Material 3
- **Networking:** Ktor Client
- **Database:** Room Database
- **DI:** Koin
- **Navigation:** Navigation Compose
- **Image Loading:** Coil
- **Serialization:** Kotlinx Serialization
- **Async:** Kotlin Coroutines & Flow
- **Auth:** Supabase Auth with OAuth (Google & Apple Sign-In)

**Configuration:**
- Min SDK: 26 (Android 8.0)
- Target SDK: 36 (Android 15)
- Compile SDK: 36
- iOS Deployment Target: iOS 15+
- App Name: "Superpets"
- Package/Bundle ID: `com.superpets.mobile`

**App Icons & Branding:**
- ‚úÖ **Android**: Adaptive icons with background, foreground, and monochrome layers
  - Location: `composeApp/src/androidMain/res/mipmap-*/`
  - Densities: mdpi, hdpi, xhdpi, xxhdpi, xxxhdpi
  - Supports Android 13+ themed icons via monochrome layer
- ‚úÖ **iOS**: Complete AppIcon set for all devices and contexts
  - Location: `iosApp/iosApp/Assets.xcassets/AppIcon.appiconset/`
  - Includes: iPhone, iPad, CarPlay, and App Store icons (1024x1024)
  - All icon sizes from 20pt to 1024pt with @2x and @3x variants
- ‚úÖ **In-App Logo**: Professional app logo integrated throughout authentication screens
  - Location: `composeApp/src/commonMain/composeResources/drawable/`
  - Assets: `app_logo.png` (113K), `app_icon.png` (48K)
  - Used in: LandingScreen header, LoginScreen, SignupScreen, Email confirmation screen
  - Accessed via Compose Resources: `painterResource(Res.drawable.app_logo)`

**Implemented Features:**
- ‚úÖ Splash screen with auth state checking
- ‚úÖ Landing page with feature highlights and professional branding
- ‚úÖ Login & Signup screens with email/password and app logo
- ‚úÖ Google OAuth Sign-In (web & mobile)
- ‚úÖ Apple OAuth Sign-In (web & mobile)
- ‚úÖ Email confirmation support with branded confirmation screen
- ‚úÖ Deep linking for OAuth callbacks
- ‚úÖ Home screen with credit display and recent creations
- ‚úÖ Editor screen with image upload UI and hero selection
- ‚úÖ Gallery picker (multi-select up to 10 images)
- ‚úÖ Hero selection screen (29 heroes with search and category tabs)
- ‚úÖ **Image generation (FULLY WORKING)** - Compress ‚Üí Upload ‚Üí API call ‚Üí Results
- ‚úÖ Generation progress screen (real-time progress tracking with animated bubbles)
- ‚úÖ Result gallery screen (swipeable HorizontalPager for generated images)
- ‚úÖ **Edit history screen** (2-column grid, date/hero filters, API integration)
- ‚úÖ Image compression utilities (Android & iOS, max 2048x2048)
- ‚úÖ Complete end-to-end flow (Gallery ‚Üí Hero ‚Üí Generation ‚Üí Results)
- ‚úÖ Credit system (validation, deduction, balance refresh)
- ‚úÖ Error handling (401, 402, 429 status codes)
- ‚ùå Camera functionality (placeholder exists, not implemented)
- ‚ùå Download action (TODO placeholder - needs platform-specific code)
- ‚ùå Share action (TODO placeholder - needs platform-specific code)
- ‚ùå Profile screen (route exists, screen not implemented)
- ‚ùå Credit purchase UI (Stripe not integrated)

**Image Upload Strategy:**
- **Backend validation**: 10MB maximum file size
- **Client-side compression required**: Resize images to max 2048x2048 before upload
  - Typical compressed size: 1-3MB (JPEG quality 80-90%)
  - Rationale: Modern phones capture 5-25MB photos; compression prevents upload failures
  - Image compression libraries available in Compose Multiplatform
- **Validation flow**:
  1. User selects photo from device storage
  2. App compresses/resizes to 2048x2048 if larger
  3. App uploads to `/nano-banana/upload-and-edit`
  4. Backend validates: file size ‚â§10MB, type is image/jpeg|png|webp|gif
- **Error handling**: Show user-friendly messages for oversized or invalid files

**API Integration:**
- Same REST API as web app: `https://api.superpets.fun`
- Supabase Auth for authentication (Supabase Kotlin client)
- Same credit system and rate limiting applies
- Ktor Client configured with kotlinx.serialization for JSON parsing

**Development Setup:**
- Android Studio Hedgehog or newer
- Xcode 15+ (for iOS development)
- JDK 11+
- Kotlin 1.9.0+
- Run Android: Open in Android Studio, select Android target
- Run iOS: Open `iosApp/iosApp.xcodeproj` in Xcode or use Android Studio iOS target

## Development Commands

### Backend (Ktor)

Navigate to `superpets-backend/`:

```bash
# Run dev server (localhost:8080)
./gradlew run

# Run with Supabase environment variables
export SUPABASE_DB_URL="postgresql://postgres.<ref>:<pass>@aws-0-us-east-1.pooler.supabase.com:6543/postgres"
export SUPABASE_URL="https://<project-ref>.supabase.co"
export SUPABASE_JWT_SECRET="<your-jwt-secret>"
export FAL_API_KEY="<your-key>"
export STRIPE_SECRET_KEY="<your-key>"
export STRIPE_WEBHOOK_SECRET="<your-secret>"
./gradlew run

# Run tests
./gradlew test

# Build JAR with dependencies
./gradlew shadowJar

# Build Docker image locally
docker build -t superpets-backend .

# Run Docker container locally
docker run -p 8080:8080 \
  -e SUPABASE_DB_URL="postgresql://..." \
  -e SUPABASE_URL="https://..." \
  -e SUPABASE_JWT_SECRET="..." \
  -e FAL_API_KEY="your_key" \
  -e STRIPE_SECRET_KEY="your_key" \
  -e STRIPE_WEBHOOK_SECRET="your_secret" \
  superpets-backend
```

**Environment Configuration:**
- Requires `.env` file in project root with Supabase credentials (DO NOT COMMIT)
- `heroes.json` must be in project root (contains hero definitions)
- See `SUPABASE_MIGRATION.md` for database setup

**Test Interface:**
- HTML test interface at `http://localhost:8080/index.html`
- Includes Supabase auth, API testing, image upload with hero selection
- Hero selection UI with "Classic Heroes" and "Unique Heroes" tabs

### Frontend (React)

Navigate to `superpets-web/`:

```bash
# Install dependencies
npm install

# Run dev server (with hot reload)
npm run dev

# Build for production
npm run build

# Preview production build
npm run preview

# Deploy to Firebase Hosting (manual)
firebase deploy

# Lint code
npm run lint
```

**Environment Variables:**
- `.env` - Development configuration (localhost backend)
- `.env.production` - Production configuration (Railway backend)
- Vite automatically loads correct env file based on mode

**CI/CD:**
- Automatic deployment via GitHub Actions on push to `main`
- Workflow file: `.github/workflows/firebase-deploy.yml`
- Setup instructions: See `GITHUB_ACTIONS_SETUP.md`
- Requires GitHub secrets: `FIREBASE_SERVICE_ACCOUNT`, `VITE_STRIPE_PUBLISHABLE_KEY`

### Mobile (Compose Multiplatform)

Navigate to `superpets-mobile/`:

```bash
# Open in Android Studio
open -a "Android Studio" superpets-mobile/

# Or open iOS project in Xcode
open superpets-mobile/iosApp/iosApp.xcodeproj

# Build Android (from command line)
cd superpets-mobile
./gradlew :composeApp:assembleDebug

# Build iOS (from command line, requires Xcode)
cd superpets-mobile
./gradlew :composeApp:embedAndSignAppleFrameworkForXcode

# Run tests (shared code)
./gradlew :composeApp:test

# Clean build
./gradlew clean
```

**Project Configuration:**
- Main code: `composeApp/src/commonMain/kotlin/com/superpets/mobile/`
- Android specific: `composeApp/src/androidMain/kotlin/com/superpets/mobile/`
- iOS specific: `composeApp/src/iosMain/kotlin/com/superpets/mobile/`
- Resources: `composeApp/src/commonMain/resources/`
- Build config: `composeApp/build.gradle.kts`

**Environment Variables:**
- Configure API URL in shared code (point to production or local backend)
- Supabase credentials for authentication
- Same backend URL as web app: `https://api.superpets.fun`

## Important Implementation Details

### Supabase Configuration
- Backend: Database connection via HikariCP with connection pooling
- Backend: JWT token verification for authentication
- Frontend: Supabase JS client SDK in `src/lib/supabase.ts`
- Mobile: Supabase Kotlin SDK with OAuth support
- **Email Confirmation:** Enabled for all new signups (see `EMAIL_CONFIRMATION_SETUP.md`)
- **OAuth Providers:** Google and Apple Sign-In configured (see `GOOGLE_OAUTH_SETUP.md` and `APPLE_OAUTH_SETUP.md`)
- **Security:** CORS set to `anyHost()` - **MUST restrict for production**

### Credit System Flow
1. User authenticates via Supabase Auth
2. First API call auto-creates user with 5 credits in PostgreSQL
3. Before image edit, credits are deducted atomically via SQL transaction
4. Edit is performed only if deduction succeeds
5. Edit history saved to PostgreSQL for user reference

### File Upload Flow
1. Client sends multipart form data to `/nano-banana/upload-and-edit`
2. Backend extracts files and metadata (including `hero_id`)
3. If `hero_id` provided, prompt generated using `HeroService.buildPrompt()`
4. Files uploaded to fal.ai storage via `NanoBananaService.uploadFile()`
5. Returned URLs and final prompt used in `editImage()` request
6. Result and history saved to Supabase PostgreSQL

### OAuth Authentication Setup
**Implemented Providers:**
- ‚úÖ **Google OAuth** (web and mobile) - See `GOOGLE_OAUTH_SETUP.md`
  - Web: OAuth 2.0 Client ID configured with redirect URIs
  - Mobile: Android (SHA-1 fingerprints) and iOS (Bundle ID) configured
  - Status: Fully functional in development and production
- ‚ö†Ô∏è **Apple Sign-In** (web and mobile) - See `APPLE_OAUTH_SETUP.md`
  - Web: Services ID configured with domain verification
  - Mobile: App ID with Sign in with Apple capability
  - Status: UI implemented, **requires active Apple Developer Program membership ($99/year)**
  - Note: Cannot test without Apple Developer account

**Configuration Files:**
- `GOOGLE_OAUTH_SETUP.md` - Complete Google OAuth setup guide
- `APPLE_OAUTH_SETUP.md` - Complete Apple Sign-In setup guide
- `EMAIL_CONFIRMATION_SETUP.md` - Email confirmation configuration
- `MOBILE_EMAIL_CONFIRMATION_SETUP.md` - Mobile-specific email confirmation

**Web Implementation:**
- Login/Signup forms in `LoginForm.tsx` and `SignupForm.tsx`
- OAuth buttons trigger `signInWithGoogle()` or `signInWithApple()` from `useAuth` hook
- Callback handled by `AuthCallbackPage.tsx` at `/auth/callback`
- Redirect URIs: `https://superpets.fun/auth/callback` and `http://localhost:5173/auth/callback`

**Mobile Implementation:**
- Login/Signup screens in `LoginScreen.kt` and `SignupScreen.kt`
- OAuth via Supabase Kotlin SDK
- Deep linking configured for OAuth callbacks (`com.superpets.mobile://`)
- Platform-specific OAuth flows for Android and iOS

### Stripe Payment Integration
- See `STRIPE_SETUP.md` for detailed implementation guide
- Checkout session creation via `/stripe/create-checkout-session`
- Webhook handling at `/stripe/webhook` for payment confirmation
- Credit packages configurable via Stripe product metadata

### Hero System Files
**Backend:**
- `heroes.json` - Hero data file (10 classics + 19 uniques)
- `src/main/kotlin/models/HeroModels.kt` - Data models
- `src/main/kotlin/services/HeroService.kt` - Hero loading and prompt building

**Frontend (Test HTML):**
- `src/main/resources/static/index.html` - Hero selection UI
  - Fetches heroes from `/heroes` endpoint
  - Displays in tabbed grid (classics/uniques)
  - Sends `hero_id` in form data

### Database Schema
See `supabase_migration.sql` for complete schema. Key tables:

**users:**
- `uid` (primary key) - Supabase user ID
- `email` - User email
- `credits` - Current credit balance
- `created_at` - Account creation timestamp

**credit_transactions:**
- `id` (UUID, primary key)
- `user_id` (foreign key to users)
- `amount` - Credit amount (positive for additions, negative for deductions)
- `type` - Transaction type (PURCHASE, SIGNUP_BONUS, DEDUCTION, etc.)
- `description` - Transaction description
- `timestamp` - Transaction timestamp

**edit_history:**
- `id` (UUID, primary key)
- `user_id` (foreign key to users)
- `prompt` - Generated prompt used
- `input_images` - JSON array of input image URLs
- `output_images` - JSON array of output image URLs
- `credits_cost` - Credits deducted for this edit
- `timestamp` - Edit timestamp

### Error Handling & Monitoring

**Error Tracking (Sentry):**
- ‚úÖ **Frontend:** Sentry integrated with React error tracking, session replay, and performance monitoring
  - Dashboard: https://alican-korkmaz.sentry.io/issues/?project=4510156145098832
  - Captures JavaScript errors, React errors, API failures
  - Session replay enabled for debugging user issues
  - User context tracking (email, user ID)
- ‚úÖ **Backend:** Sentry integrated with Ktor exception handling
  - Dashboard: https://alican-korkmaz.sentry.io/issues/?project=4510156138348624
  - Captures all unhandled exceptions via StatusPages plugin
  - Captures 500 Internal Server errors
  - Performance monitoring enabled
  - Does NOT capture normal 401/404 responses (reduces noise)
- See `SENTRY_DEPLOYMENT_GUIDE.md` for configuration details

**HTTP Error Codes:**
- `401 Unauthorized` - Invalid/expired Supabase JWT token
- `402 Payment Required` - Insufficient credits
- `500 Internal Server Error` - Server-side errors (tracked in Sentry)
- Credits checked before API calls, refunds not implemented
- All database operations wrapped in try/catch with logging

## Git Repository

- **GitHub:** `https://github.com/alicankorkmaz-sudo/superpets`
- **Branch:** `main`
- **Structure:** Monorepo with separate subdirectories for backend, web, and mobile

## Next Steps / TODO

See `PROJECT_STATE.md` for current progress and next steps.

**Completed (Oct 5-21, 2025):**
- ‚úÖ Deployed backend to Railway with Supabase pooler connection (Oct 13)
- ‚úÖ Migrated from Firebase to Supabase (PostgreSQL + Auth) (Oct 5)
- ‚úÖ Deployed frontend to Firebase Hosting (Oct 5)
- ‚úÖ Configured custom domain: superpets.fun (Oct 5)
- ‚úÖ Implemented CORS restrictions (production and development domains) (Oct 8)
- ‚úÖ Added comprehensive rate limiting (per-user and IP-based) (Oct 8)
- ‚úÖ Added file upload validation (10MB max, type checking) (Oct 8)
- ‚úÖ Created welcoming landing page for new users (Oct 8)
- ‚úÖ Implemented URL-based navigation with browser history support (Oct 8)
- ‚úÖ Removed orphaned Firebase service files from backend (Oct 5)
- ‚úÖ Set up Compose Multiplatform mobile project (Android & iOS) (Oct 10)
- ‚úÖ **Integrated Sentry error tracking** (frontend and backend) (Oct 13)
- ‚úÖ **Migrated backend from Render to Railway** (Oct 13)
- ‚úÖ **Implemented Google OAuth Sign-In** (web and mobile) (Oct 14-15)
- ‚úÖ **Implemented Apple OAuth Sign-In** (web and mobile - UI ready, awaiting Apple Developer account) (Oct 15)
- ‚úÖ **Created Terms of Service and Privacy Policy pages** (Oct 8)
- ‚úÖ **Enabled email confirmation for new signups** (Oct 14)
- ‚úÖ **Built mobile app authentication screens** (Login, Signup, Landing, Splash) (Oct 14-15)
- ‚úÖ **Integrated mobile deep linking for OAuth callbacks** (Oct 14)
- ‚úÖ **Integrated professional app icons** (Android, iOS, and web with PWA support) (Oct 16)
- ‚úÖ **Integrated app logo in mobile authentication screens** (Landing, Login, Signup, Email confirmation) (Oct 21)
- ‚úÖ **Implemented mobile editor screens** (Home, Editor, Hero Selection, Generation Progress, Result Gallery) (Nov 3)
- ‚úÖ **Gallery picker integration** (multi-select up to 10 images) (Nov 3)
- ‚úÖ **Image compression utilities** (Android & iOS, max 2048x2048) (Nov 3)
- ‚úÖ **Complete navigation flow** (Create ‚Üí Hero ‚Üí Generation ‚Üí Results) (Nov 3)
- ‚úÖ **Image generation API fully working** (compress, upload, multipart form-data, error handling) (Nov 3)
- ‚úÖ **Real-time progress tracking** (GenerationProgressScreen updates from ViewModel state) (Nov 3)
- ‚úÖ **Edit history screen** (2-column grid, date/hero filters fully working, clear filters button) (Nov 6)

**Remaining priorities:**
1. **Test mobile end-to-end flow** (gallery ‚Üí hero ‚Üí generation ‚Üí results ‚Üí history is FULLY working)
2. **Build profile screen** (route exists, screen not implemented)
3. **Implement Download/Share actions** (TODO placeholders exist in navigation - needs platform-specific Android/iOS code)
4. **Add camera functionality** (placeholder callback exists in EditorScreen)
5. **Add credit purchase UI** (Stripe checkout integration for mobile)
6. **Complete Stripe payment integration** (checkout sessions configured, needs webhook testing)
7. **Apple Developer account activation** (required for Apple Sign-In to work in production)
8. **Test end-to-end user flows on web** (signup ‚Üí confirm email ‚Üí login ‚Üí edit images ‚Üí purchase credits)
9. **Monitor Railway backend performance and costs**

See `LAUNCH_CHECKLIST.md` for comprehensive pre-launch checklist.

## Notes

- **memorize** - This instruction ensures AI assistants remember key project details
- All secrets managed via environment variables (never committed to git)
- Supabase credentials stored as environment variables for deployment
- Hero prompt system is server-side only (clients cannot send custom prompts)
- **Migrated from Firebase to Supabase** (October 5, 2025)
- **Deployed to Railway** (backend, October 13, 2025)
- memorize
- Whenever I command you to 'syncw' you should always:
- Save our work
- Sync related files including AI docs
- Git push